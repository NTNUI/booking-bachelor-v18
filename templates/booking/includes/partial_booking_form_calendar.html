{#form that is called when creating a new booking#}
{% load static %}
{% load tags %}

{% block content %}
    <div id="content-container" class="row">
        <div class="col-lg-6" id="booking-cards-con">
            <div id="booking-cards">
            </div>
        </div>
        {% if user.is_authenticated %}
            {% user_in_hs user as user_in_hs %}
            {% if user_in_hs or request.user.is_superuser %}
                {% load widget_tweaks %}
                <div class="col-lg-5" id="booking-fields">
                    <div class="col form-group {% if field.errors %} has-error{% endif %}">
                        {{form.person.as_hidden}}
                        {{form.location.as_hidden}}
                        <h5>Title</h5>
                        {{form.title}}
                        <h5>Description</h5>
                        {{form.description}}
                        <h5>Group</h5>
                        {{form.group}}
                        {% if request.user.is_superuser %}
                            <div class="form-padding">
                                <h5>Recurring</h5>
                                <select class="form-control" id="recurringEvent">
                                    <option value="noRepeat" id="noRepeat">Does not repeat</option>
                                    <option value="weekly" id="weekly">Repeat every</option>
                                </select>
                            </div>
                        {% endif %}
                        {% if user.is_authenticated and not request.user.is_superuser %}
                            {% user_in_hs user as user_in_hs %}
                            {% if user_in_hs %}
                                <div class="form-padding">
                                    <h5>Request Recurring</h5>
                                    <select class="form-control" id="recurringEvent">
                                        <option value="noRepeat" id="noRepeat">Does not repeat</option>
                                        <option value="weekly" id="weekly">Repeat every</option>
                                    </select>
                                </div>
                            {% endif %}
                        {% endif %}

                        <div class="form-padding">
                            <h5>Starttime</h5>
                            <div class="input-group clockpicker" data-placement="left" data-align="bottom" data-autoclose="true" id="startTime">
                                <input type="text" class="form-control" value="Choose start time" id="startInput" onclick="resetClock()" required>
                                <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                                </span>
                            </div>
                        </div>
                        <div class="form-padding">
                            <h5>Endtime</h5>
                            <div class="input-group clockpicker" data-placement="left" data-align="bottom" data-autoclose="true" id="endTime" >
                                <input type="text" class="form-control" value="Choose end time" id="endInput" onclick="editClock()" required>
                                <span class="input-group-addon" i id="endTimeSpan">
                                <span class="glyphicon glyphicon-time" ></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endblock content %}

{% block script %}
    <script>
        var list_of_bookings = []
        var chosenLocation = this.currentLocation;
        $(document).ready(function(){
            var $myForm = $('#createform');
            $myForm.submit(function(event){
                event.preventDefault()
                // append start date to post request
                var start_time = document.getElementById("startInput").value;
                var end_time = document.getElementById("endInput").value;
                var $form_data = $(this).serialize()+"&start="+tempDay.id.toString() + " " + start_time + "&end="+tempDay.id.toString() + " " + end_time + "&location=" + " " + chosenLocation;
                var overlap = false;
                $.ajax({
                    method: "POST",
                    url: '/booking/bookings_list/create_calendar/',
                    data: $form_data,
                    // close popup on success

                    beforeSend: function(data) {
                        var modal = document.getElementById('booking-modal');
                        $( list_of_bookings ).each(function( index ) {

                            var s = list_of_bookings[index][1].replace(":", "");
                            var e = list_of_bookings[index][2].slice(11, 16).replace(":", "");
                            var s0 = start_time.slice(0, 5).replace(":", "");
                            var e0 = end_time.slice(0, 5).replace(":", "");
                            if((s >= s0 && e > s0)||
                                (s < e0 && e > e0)||
                                (s > s0 && e <= e0)||
                                (s <= s0 && e >= e0)) {
                                overlap = true;
                            }
                            if (overlap) {
                            data.abort();
                                swal({
                                    title: "Ops! Looks like a booking already exists on that time range",
                                    text: "Do you want to enqueue your booking?",
                                    buttons: ["No", "Yes"],
                                    successMode: true,
                                    })
                                    .then((willQueue) => {
                                        if (willQueue) {
                                            swal("Great! Your booking is now in the queue.", {
                                                icon: "success",
                                                buttons: false,
                                                timer: 3000,
                                            });
                                            console.log("hei fride")
                                            var modal = document.getElementById('booking-modal');
                                            modal.style.display = "none";
                                        } else {

                                            console.log("nei?")
                                        }
                                    });
                            }
                            else {
                                swal("Great! you just made a new booking", {
                                    icon: "success",
                                    buttons: false,
                                    timer: 3000,
                                });
                            }
                        });
                    },
                    success: function(data) {

                        var date_format = tempDay.id.slice(0, 10);
                        if (!overlap) {
                            var modal = document.getElementById('booking-modal');
                            //modal.style.display = "none";
                            swal("Congrats! you just made a new booking", {
                                    icon: "success",
                                    buttons: false,
                                    timer: 3000,
                                });
                        }


                    },
                    complete: function(data) {
                        var modal = document.getElementById('booking-modal');
                        modal.style.display = "none";
                        var promised = promiseTest();
                        promised.done(function() {
                            promised.then( function() {
                                global_list = []
                                global_list.push(promised.responseJSON);
                            })
                        })
                    },

                })
            })
        })
        $.ajax({
            method: "GET",
            url: '/booking/api',
            beforeSend: function(){
                var promised = promiseTest();
                    promised.done(function() {
                        promised.then( function() {
                            global_list = []
                            global_list.push(promised.responseJSON);
                    })
                })
            },
            success: function(data) {
                $.each(data, function(i, item) {
                    var date = data[i].start;
                    var date_format = date.slice(0, 10);
                    var start = date.slice(11, 16);
                    var newDate = start.replace(":", "");
                    var loc = global_list[0][i].location__name;
                    loc = document.getElementById(loc);
                    var loc = global_list[0][i].location__name;
                    loc = document.getElementById(loc);
                    if(tempDay.id === date_format && data[i].location__name === loc.value && loc.checked === true) {
                        booking = []
                        booking.push(newDate, start, data[i].end, data[i].title, data[i].person__first_name);
                        list_of_bookings.push(booking)
                        list_of_bookings.sort(function(a, b){return a[0] - b[0]});
                    }
                })
                if(list_of_bookings.length != 0){
                    for (var I = 0; I < list_of_bookings.length; I++) {
                        var div = document.createElement("div");
                        div.className = "col-sm-10";
                        var div2 = document.createElement("div");
                        div2.className = "card";
                        var div3 = document.createElement("div");
                        div3.className = "card-body";
                        var date = document.createElement("h5");
                        date.className = "card-title";
                        var start_time = list_of_bookings[I][1];
                        var end_time = list_of_bookings[I][2].slice(11, 16);
                        date.innerHTML = start_time + "-" + end_time;
                        var title = document.createElement("p");
                        title.className = "card-text";
                        var b_title = list_of_bookings[I][3]
                        title.innerHTML = b_title;
                        var name = document.createElement("h6");
                        name.className = "card-subtitle mb-2 text-muted";
                        var b_name = list_of_bookings[I][4]
                        name.innerHTML = b_name;
                        div3.appendChild(date);
                        div3.appendChild(title);
                        div3.appendChild(name);
                        div2.appendChild(div3);
                        div.appendChild(div2);
                        document.getElementById("booking-cards").appendChild(div);
                    }
                }else {
                    var empty = document.createElement("h5");
                    empty.innerHTML = "No bookings today!";
                    empty.className = "empty";
                    document.getElementById("booking-cards").appendChild(empty);
                }
            }
        });
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script type="text/javascript" src="{% static 'js/popup.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/clockpicker.js' %}"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
{% endblock script %}